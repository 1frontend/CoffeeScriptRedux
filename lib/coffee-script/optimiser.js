// Generated by CoffeeScript 1.3.3
var CS, any, beingDeclared, concat, concatMap, declarationsFor, difference, envEnrichments, exports, foldl, foldl1, isFalsey, isTruthy, makeDispatcher, mayHaveSideEffects, union, usedAsExpression, walk, _ref, _ref1, _ref2,
  __slice = [].slice,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  __hasProp = {}.hasOwnProperty;

_ref = require('./functional-helpers'), any = _ref.any, concat = _ref.concat, concatMap = _ref.concatMap, difference = _ref.difference, foldl = _ref.foldl, foldl1 = _ref.foldl1, union = _ref.union;

_ref1 = require('./helpers'), beingDeclared = _ref1.beingDeclared, declarationsFor = _ref1.declarationsFor, usedAsExpression = _ref1.usedAsExpression, envEnrichments = _ref1.envEnrichments;

CS = require('./nodes');

exports = (_ref2 = typeof module !== "undefined" && module !== null ? module.exports : void 0) != null ? _ref2 : this;

makeDispatcher = function(defaultValue, handlers, defaultHandler) {
  var ctor, ctors, handler, handlers_, _i, _j, _len, _len1, _ref3;
  if (defaultHandler == null) {
    defaultHandler = (function() {});
  }
  handlers_ = {};
  for (_i = 0, _len = handlers.length; _i < _len; _i++) {
    _ref3 = handlers[_i], ctors = _ref3[0], handler = _ref3[1];
    for (_j = 0, _len1 = ctors.length; _j < _len1; _j++) {
      ctor = ctors[_j];
      handlers_[ctor.prototype.className] = handler;
    }
  }
  return function() {
    var args, node;
    node = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    if (node == null) {
      return defaultValue;
    }
    handler = Object.prototype.hasOwnProperty.call(handlers_, node.className) ? handlers_[node.className] : defaultHandler;
    return handler.apply(node, args);
  };
};

isTruthy = makeDispatcher(false, [
  [
    [CS.ArrayInitialiser, CS.Class, CS.DeleteOp, CS.ForIn, CS.ForOf, CS.Function, CS.BoundFunction, CS.HeregExp, CS.ObjectInitialiser, CS.Range, CS.RegExp, CS.Slice, CS.TypeofOp, CS.While], function() {
      return true;
    }
  ], [
    [CS.AssignOp], function() {
      return isTruthy(this.expression);
    }
  ], [
    [CS.Block], function() {
      if (this.statements.length === 0) {
        return false;
      } else {
        return isTruthy(this.statements[this.statements.length - 1]);
      }
    }
  ], [
    [CS.Bool, CS.Float, CS.Int, CS.String], function() {
      return !!this.data;
    }
  ], [
    [CS.Conditional], function() {
      return (isTruthy(this.condition)) && (isTruthy(this.block)) || (isFalsey(this.condition)) && isTruthy(this.elseBlock);
    }
  ], [
    [CS.LogicalAndOp], function() {
      return (isTruthy(this.left)) && isTruthy(this.right);
    }
  ], [
    [CS.LogicalNotOp], function() {
      return isFalsey(this.expression);
    }
  ], [
    [CS.LogicalOrOp], function() {
      return (isTruthy(this.left)) || isTruthy(this.right);
    }
  ], [
    [CS.Program], function() {
      return isTruthy(this.block);
    }
  ], [
    [CS.SeqOp], function() {
      return isTruthy(this.right);
    }
  ], [
    [CS.UnaryExistsOp], function() {
      return (isTruthy(this.expression)) || this.expression["instanceof"](CS.Int, CS.Float, CS.String, CS.UnaryPlusOp, CS.UnaryNegateOp, CS.LogicalNotOp);
    }
  ]
], function() {
  return false;
});

isFalsey = makeDispatcher(false, [
  [
    [CS.Null, CS.Undefined], function() {
      return true;
    }
  ], [
    [CS.AssignOp], function() {
      return isFalsey(this.expression);
    }
  ], [
    [CS.Block], function() {
      if (this.statements.length === 0) {
        return true;
      } else {
        return isFalsey(this.statements[this.statements.length - 1]);
      }
    }
  ], [
    [CS.Bool, CS.Float, CS.Int, CS.String], function() {
      return !this.data;
    }
  ], [
    [CS.Conditional], function() {
      return (isTruthy(this.condition)) && (isFalsey(this.block)) || (isFalsey(this.condition)) && isFalsey(this.elseBlock);
    }
  ], [
    [CS.LogicalAndOp], function() {
      return (isFalsey(this.left)) || isFalsey(this.right);
    }
  ], [
    [CS.LogicalNotOp], function() {
      return isTruthy(this.expression);
    }
  ], [
    [CS.LogicalOrOp], function() {
      return (isFalsey(this.left)) && isFalsey(this.right);
    }
  ], [
    [CS.Program], function() {
      return isFalsey(this.block);
    }
  ], [
    [CS.SeqOp], function() {
      return isFalsey(this.right);
    }
  ], [
    [CS.UnaryExistsOp], function() {
      return this.expression["instanceof"](CS.Null, CS.Undefined);
    }
  ]
], function() {
  return false;
});

mayHaveSideEffects = makeDispatcher(false, [
  [
    [CS.ClassProtoAssignOp, CS.Function, CS.BoundFunction, CS.Null, CS.RegExp, CS.This, CS.Undefined], function() {
      return false;
    }
  ], [
    [CS.Break, CS.Continue, CS.DeleteOp, CS.NewOp, CS.Return, CS.Super, CS.PreDecrementOp, CS.PreIncrementOp, CS.PostDecrementOp, CS.PostIncrementOp], function() {
      return true;
    }
  ], [
    [CS.ArrayInitialiser], function(inScope) {
      return any(this.members, function(m) {
        return mayHaveSideEffects(m, inScope);
      });
    }
  ], [
    [CS.Block], function(inScope) {
      return any(this.statements, function(s) {
        return mayHaveSideEffects(s, inScope);
      });
    }
  ], [
    [CS.Class], function(inScope) {
      return (mayHaveSideEffects(this.parent, inScope)) || (this.nameAssignment != null) && (this.name || (beingDeclared(this.nameAssignment)).length > 0);
    }
  ], [
    [CS.Conditional], function(inScope) {
      return (mayHaveSideEffects(this.condition, inScope)) || (!isFalsey(this.condition)) && (mayHaveSideEffects(this.block, inScope)) || (!isTruthy(this.condition)) && mayHaveSideEffects(this.elseBlock, inScope);
    }
  ], [
    [CS.DoOp], function(inScope) {
      var args, newScope, p;
      if (!this.expression["instanceof"](CS.Function, CS.BoundFunction)) {
        return true;
      }
      newScope = difference(inScope, concatMap(this.expression.parameters, beingDeclared));
      args = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this.expression.parameters;
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          p = _ref3[_i];
          if (p["instanceof"](CS.AssignOp)) {
            _results.push(p.expression);
          } else {
            _results.push(p);
          }
        }
        return _results;
      }).call(this);
      if (any(args, function(a) {
        return mayHaveSideEffects(a, newScope);
      })) {
        return true;
      }
      return mayHaveSideEffects(this.expression, newScope);
    }
  ], [
    [CS.FunctionApplication], function(inScope) {
      var newScope;
      if (!this["function"]["instanceof"](CS.Function, CS.BoundFunction)) {
        return true;
      }
      newScope = difference(inScope, concatMap(this["function"].parameters, beingDeclared));
      if (any(this["arguments"], function(a) {
        return mayHaveSideEffects(a, newScope);
      })) {
        return true;
      }
      return mayHaveSideEffects(this["function"].block, newScope);
    }
  ], [
    [CS.ObjectInitialiser], function(inScope) {
      return any(this.members, function(m) {
        return mayHaveSideEffects(m, inScope);
      });
    }
  ], [
    [CS.ObjectInitialiserMember], function(inScope) {
      return (mayHaveSideEffects(this.key, inScope)) || mayHaveSideEffects(this.expression, inScope);
    }
  ], [
    [CS.Switch], function(inScope) {
      return any([this.expression, this.elseBlock].concat(__slice.call(this.cases)), function(e) {
        return mayHaveSideEffects(e, inScope);
      });
    }
  ], [
    [CS.SwitchCase], function(inScope) {
      return any([this.block].concat(__slice.call(this.conditions)), function(e) {
        return mayHaveSideEffects(e, inScope);
      });
    }
  ], [
    [CS.While], function(inScope) {
      return (mayHaveSideEffects(this.condition, inScope)) || (!isFalsey(this.condition)) && mayHaveSideEffects(this.block, inScope);
    }
  ], [
    [CS.AssignOp, CS.ClassProtoAssignOp, CS.CompoundAssignOp, CS.ExistsAssignOp], function(inScope) {
      return (mayHaveSideEffects(this.expression, inScope)) || (beingDeclared(this.assignee)).length > 0;
    }
  ], [
    [CS.Bool, CS.Float, CS.Identifier, CS.Int, CS.JavaScript, CS.String], function() {
      return false;
    }
  ]
], function(inScope) {
  var _this = this;
  return any(this.childNodes, function(child) {
    return mayHaveSideEffects(_this[child], inScope);
  });
});

walk = (function() {
  var walkDefault, walk_;
  walk_ = {
    ArrayInitialiser: function(fn, inScope, ancestry) {
      var member;
      if (inScope == null) {
        inScope = [];
      }
      if (ancestry == null) {
        ancestry = [];
      }
      if (__indexOf.call(ancestry, this) >= 0) {
        return this;
      }
      ancestry = [this].concat(__slice.call(ancestry));
      this.members = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this.members;
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          member = _ref3[_i];
          while (member !== walk((member = fn.call(member, inScope, ancestry)), fn, inScope, ancestry)) {
            continue;
          }
          inScope = union(inScope, envEnrichments(member));
          _results.push(member);
        }
        return _results;
      }).call(this);
      ancestry.shift();
      return fn.call(this, inScope, ancestry);
    },
    Block: function(fn, inScope, ancestry) {
      var statement;
      if (inScope == null) {
        inScope = [];
      }
      if (ancestry == null) {
        ancestry = [];
      }
      if (__indexOf.call(ancestry, this) >= 0) {
        return this;
      }
      ancestry = [this].concat(__slice.call(ancestry));
      this.statements = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this.statements;
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          statement = _ref3[_i];
          while (statement !== walk((statement = fn.call(statement, inScope, ancestry)), fn, inScope, ancestry)) {
            continue;
          }
          inScope = union(inScope, envEnrichments(statement));
          _results.push(statement);
        }
        return _results;
      }).call(this);
      ancestry.shift();
      return fn.call(this, inScope, ancestry);
    },
    Function: function(fn, inScope, ancestry) {
      var param;
      if (inScope == null) {
        inScope = [];
      }
      if (ancestry == null) {
        ancestry = [];
      }
      if (__indexOf.call(ancestry, this) >= 0) {
        return this;
      }
      ancestry = [this].concat(__slice.call(ancestry));
      this.parameters = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this.parameters;
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          param = _ref3[_i];
          while (param !== walk((param = fn.call(param, inScope, ancestry)), fn, inScope, ancestry)) {
            continue;
          }
          inScope = union(inScope, envEnrichments(param));
          _results.push(param);
        }
        return _results;
      }).call(this);
      if (this.block != null) {
        while (this.block !== walk((this.block = fn.call(this.block, inScope, ancestry)), fn, inScope, ancestry)) {
          continue;
        }
      }
      ancestry.shift();
      return fn.call(this, inScope, ancestry);
    },
    FunctionApplication: function(fn, inScope, ancestry) {
      var arg;
      if (inScope == null) {
        inScope = [];
      }
      if (ancestry == null) {
        ancestry = [];
      }
      if (__indexOf.call(ancestry, this) >= 0) {
        return this;
      }
      ancestry = [this].concat(__slice.call(ancestry));
      while (this["function"] !== walk((this["function"] = fn.call(this["function"], inScope, ancestry)), fn, inScope, ancestry)) {
        continue;
      }
      inScope = union(inScope, envEnrichments(this["function"]));
      this["arguments"] = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this["arguments"];
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          arg = _ref3[_i];
          while (arg !== walk((arg = fn.call(arg, inScope, ancestry)), fn, inScope, ancestry)) {
            continue;
          }
          inScope = union(inScope, envEnrichments(arg));
          _results.push(arg);
        }
        return _results;
      }).call(this);
      ancestry.shift();
      return fn.call(this, inScope, ancestry);
    },
    NewOp: function(fn, inScope, ancestry) {
      var arg;
      if (inScope == null) {
        inScope = [];
      }
      if (ancestry == null) {
        ancestry = [];
      }
      if (__indexOf.call(ancestry, this) >= 0) {
        return this;
      }
      ancestry = [this].concat(__slice.call(ancestry));
      while (this.constructor !== walk((this.constructor = fn.call(this.constructor, inScope, ancestry)), fn, inScope, ancestry)) {
        continue;
      }
      inScope = union(inScope, envEnrichments(this.constructor));
      this["arguments"] = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this["arguments"];
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          arg = _ref3[_i];
          while (arg !== walk((arg = fn.call(arg, inScope, ancestry)), fn, inScope, ancestry)) {
            continue;
          }
          inScope = union(inScope, envEnrichments(arg));
          _results.push(arg);
        }
        return _results;
      }).call(this);
      ancestry.shift();
      return fn.call(this, inScope, ancestry);
    },
    ObjectInitialiser: function(fn, inScope, ancestry) {
      var member;
      if (inScope == null) {
        inScope = [];
      }
      if (ancestry == null) {
        ancestry = [];
      }
      if (__indexOf.call(ancestry, this) >= 0) {
        return this;
      }
      ancestry = [this].concat(__slice.call(ancestry));
      this.members = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this.members;
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          member = _ref3[_i];
          while (member !== walk((member = fn.call(member, inScope, ancestry)), fn, inScope, ancestry)) {
            continue;
          }
          inScope = union(inScope, envEnrichments(member));
          _results.push(member);
        }
        return _results;
      }).call(this);
      ancestry.shift();
      return fn.call(this, inScope, ancestry);
    },
    Super: function(fn, inScope, ancestry) {
      var arg;
      if (inScope == null) {
        inScope = [];
      }
      if (ancestry == null) {
        ancestry = [];
      }
      if (__indexOf.call(ancestry, this) >= 0) {
        return this;
      }
      ancestry = [this].concat(__slice.call(ancestry));
      this["arguments"] = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this["arguments"];
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          arg = _ref3[_i];
          while (arg !== walk((arg = fn.call(arg, inScope, ancestry)), fn, inScope, ancestry)) {
            continue;
          }
          inScope = union(inScope, envEnrichments(arg));
          _results.push(arg);
        }
        return _results;
      }).call(this);
      ancestry.shift();
      return fn.call(this, inScope, ancestry);
    },
    Switch: function(fn, inScope, ancestry) {
      var case_;
      if (inScope == null) {
        inScope = [];
      }
      if (ancestry == null) {
        ancestry = [];
      }
      if (__indexOf.call(ancestry, this) >= 0) {
        return this;
      }
      ancestry = [this].concat(__slice.call(ancestry));
      if (this.expression != null) {
        while (this.expression !== walk((this.expression = fn.call(this.expression, inScope, ancestry)), fn, inScope, ancestry)) {
          continue;
        }
        inScope = union(inScope, envEnrichments(this.expression));
      }
      this.cases = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this.cases;
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          case_ = _ref3[_i];
          while (case_ !== walk((case_ = fn.call(case_, inScope, ancestry)), fn, inScope, ancestry)) {
            continue;
          }
          inScope = union(inScope, envEnrichments(case_));
          _results.push(case_);
        }
        return _results;
      }).call(this);
      if (typeof elseBlock !== "undefined" && elseBlock !== null) {
        while (this.elseBlock !== walk((this.elseBlock = fn.call(this.elseBlock, inScope, ancestry)), fn, inScope, ancestry)) {
          continue;
        }
      }
      ancestry.shift();
      return fn.call(this, inScope, ancestry);
    },
    SwitchCase: function(fn, inScope, ancestry) {
      var condition;
      if (inScope == null) {
        inScope = [];
      }
      if (ancestry == null) {
        ancestry = [];
      }
      if (__indexOf.call(ancestry, this) >= 0) {
        return this;
      }
      ancestry = [this].concat(__slice.call(ancestry));
      this.conditions = (function() {
        var _i, _len, _ref3, _results;
        _ref3 = this.conditions;
        _results = [];
        for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
          condition = _ref3[_i];
          while (condition !== walk((condition = fn.call(condition, inScope, ancestry)), fn, inScope, ancestry)) {
            continue;
          }
          inScope = union(inScope, envEnrichments(condition));
          _results.push(condition);
        }
        return _results;
      }).call(this);
      while (this.block !== walk((this.block = fn.call(this.block, inScope, ancestry)), fn, inScope, ancestry)) {
        continue;
      }
      ancestry.shift();
      return fn.call(this, inScope, ancestry);
    }
  };
  walkDefault = function(fn, inScope, ancestry) {
    var child, childName, _i, _len, _ref3;
    if (inScope == null) {
      inScope = [];
    }
    if (ancestry == null) {
      ancestry = [];
    }
    if (__indexOf.call(ancestry, this) >= 0) {
      return this;
    }
    ancestry = [this].concat(__slice.call(ancestry));
    _ref3 = this.childNodes;
    for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
      childName = _ref3[_i];
      child = this[childName];
      if (child != null) {
        while (child !== walk((child = fn.call(child, inScope, ancestry)), fn, inScope, ancestry)) {
          continue;
        }
        inScope = union(inScope, envEnrichments(child));
        this[childName] = child;
      }
      child;

    }
    ancestry.shift();
    return fn.call(this, inScope, ancestry);
  };
  return function() {
    var args, handler, handlers, key, node, val;
    node = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    handlers = {};
    for (key in walk_) {
      if (!__hasProp.call(walk_, key)) continue;
      val = walk_[key];
      handlers[CS[key].prototype.className] = val;
    }
    handler = Object.prototype.hasOwnProperty.call(handlers, node.className) ? handlers[node.className] : walkDefault;
    return handler.apply(node, args);
  };
})();

exports.Optimiser = (function() {
  var defaultRules;

  Optimiser.isTruthy = isTruthy;

  Optimiser.isFalsey = isFalsey;

  Optimiser.mayHaveSideEffects = mayHaveSideEffects;

  defaultRules = [
    [
      CS.Program, function() {
        if ((this.block != null) && mayHaveSideEffects(this.block, [])) {
          return this;
        } else {
          return new CS.Program(null);
        }
      }
    ], [
      CS.Block, function(inScope, ancestors) {
        var canDropLast, stmts,
          _this = this;
        canDropLast = !usedAsExpression(this, ancestors);
        stmts = concat((function() {
          var i, s, _i, _len, _ref3, _results;
          _ref3 = _this.statements;
          _results = [];
          for (i = _i = 0, _len = _ref3.length; _i < _len; i = ++_i) {
            s = _ref3[i];
            switch (false) {
              case !((!mayHaveSideEffects(s, inScope)) && (canDropLast || i + 1 !== _this.statements.length)):
                _results.push([declarationsFor(s)]);
                break;
              case !s["instanceof"](CS.Block):
                _results.push(s.statements);
                break;
              case !s["instanceof"](CS.SeqOp):
                _results.push([s.left, s.right]);
                break;
              default:
                _results.push([s]);
            }
          }
          return _results;
        })());
        switch (stmts.length) {
          case 0:
            return (new CS.Undefined).g();
          case 1:
            return stmts[0];
          default:
            return foldl1(stmts, function(expr, s) {
              return new CS.SeqOp(expr, s);
            });
        }
      }
    ], [
      CS.SeqOp, function(inScope, ancestors) {
        if (mayHaveSideEffects(this.left, inScope)) {
          if ((mayHaveSideEffects(this.right, inScope)) || usedAsExpression(this, ancestors)) {
            return this;
          } else {
            return this.left;
          }
        } else if ((this.right["instanceof"](CS.Identifier)) && this.right.data === 'eval') {
          if ((this.left["instanceof"](CS.Int)) && this.left.data === 0) {
            return this;
          }
          return new CS.SeqOp((new CS.Int(0)).g(), this.right);
        } else {
          return this.right;
        }
      }
    ], [
      CS.AssignOp, function() {
        if (!this.expression["instanceof"](CS.SeqOp)) {
          return this;
        }
        return new CS.SeqOp(this.expression.left, new CS.AssignOp(this.assignee, this.expression.right));
      }
    ], [
      CS.While, function(inScope) {
        if (isFalsey(this.condition)) {
          if (mayHaveSideEffects(this.condition, inScope)) {
            return this.condition;
          } else {
            if (typeof block !== "undefined" && block !== null) {
              return declarationsFor(this.block);
            } else {
              return (new CS.Undefined).g();
            }
          }
        }
        if (isTruthy(this.condition)) {
          if (!mayHaveSideEffects(this.condition, inScope)) {
            if (this.block == null) {
              return (new CS.Undefined).g();
            }
            if (this instanceof CS.Loop) {
              return this;
            }
            return (new CS.Loop(this.block)).g();
          }
        }
        return this;
      }
    ], [
      CS.Conditional, function(inScope) {
        var block, removedBlock;
        if (isFalsey(this.condition)) {
          block = this.elseBlock;
          removedBlock = this.block;
        } else if (isTruthy(this.condition)) {
          block = this.block;
          removedBlock = this.elseBlock;
        } else {
          return this;
        }
        if (removedBlock != null) {
          block = new CS.SeqOp(declarationsFor(removedBlock), block);
        }
        if (mayHaveSideEffects(this.condition, inScope)) {
          block = new CS.SeqOp(this.condition, block);
        }
        return block;
      }
    ], [
      CS.ForIn, function(inScope, ancestors) {
        var retVal;
        if (!((this.expression["instanceof"](CS.ArrayInitialiser)) && this.expression.members.length === 0)) {
          return this;
        }
        retVal = usedAsExpression(this, ancestors) ? new CS.ArrayInitialiser([]) : new CS.Undefined;
        return new CS.SeqOp(declarationsFor(this), retVal.g());
      }
    ], [
      CS.ForOf, function() {
        var retVal;
        if (!((this.expression["instanceof"](CS.ObjectInitialiser)) && this.expression.isOwn && this.expression.members.length === 0)) {
          return this;
        }
        retVal = usedAsExpression(this, ancestors) ? new CS.ArrayInitialiser([]) : new CS.Undefined;
        return new CS.SeqOp(declarationsFor(this), retVal.g());
      }
    ], [
      CS.ExistsOp, function() {
        if (this.left["instanceof"](CS.Null, CS.Undefined)) {
          return this.right;
        } else {
          return this;
        }
      }
    ], [
      CS.UnaryExistsOp, function() {
        if (this.expression["instanceof"](CS.Null, CS.Undefined)) {
          return (new CS.Bool(false)).g();
        } else {
          return this;
        }
      }
    ], [
      CS.LogicalNotOp, function(inScope) {
        switch (false) {
          case !this.expression["instanceof"](CS.Int, CS.Float, CS.String, CS.Bool):
            return (new Bool(!this.expression.data)).g();
          case !this.expression["instanceof"](CS.Function, CS.BoundFunction):
            return (new CS.Bool(false)).g();
          case !this.expression["instanceof"](CS.Null, CS.Undefined):
            return (new CS.Bool(true)).g();
          case !this.expression["instanceof"](CS.ArrayInitialiser, CS.ObjectInitialiser):
            if (mayHaveSideEffects(this.expression, inScope)) {
              return this;
            } else {
              return new CS.SeqOp(declarationsFor(this.expression), (new CS.Bool(false)).g());
            }
            break;
          case !this.expression["instanceof"](CS.LogicalNotOp):
            if (this.expression.expression["instanceof"](CS.LogicalNotOp)) {
              return this.expression.expression;
            } else {
              return this;
            }
            break;
          default:
            return this;
        }
      }
    ], [
      CS.TypeofOp, function() {
        switch (false) {
          case !this.expression["instanceof"](CS.Int, CS.Float, CS.UnaryNegateOp, CS.UnaryPlusOp):
            return (new String('number')).g();
          case !this.expression["instanceof"](CS.String):
            return (new CS.String('string')).g();
          case !this.expression["instanceof"](CS.Function, CS.BoundFunction):
            return (new CS.String('function')).g();
          case !this.expression["instanceof"](CS.Undefined):
            return (new CS.String('undefined')).g();
          default:
            return this;
        }
      }
    ]
  ];

  function Optimiser() {
    var ctor, ctors, handler, _i, _j, _k, _len, _len1, _ref3;
    this.rules = {};
    for (_i = 0, _len = defaultRules.length; _i < _len; _i++) {
      _ref3 = defaultRules[_i], ctors = 2 <= _ref3.length ? __slice.call(_ref3, 0, _j = _ref3.length - 1) : (_j = 0, []), handler = _ref3[_j++];
      for (_k = 0, _len1 = ctors.length; _k < _len1; _k++) {
        ctor = ctors[_k];
        this.addRule(ctor.prototype.className, handler);
      }
    }
  }

  Optimiser.prototype.addRule = function(ctor, handler) {
    var _base, _ref3;
    ((_ref3 = (_base = this.rules)[ctor]) != null ? _ref3 : _base[ctor] = []).push(handler);
  };

  Optimiser.prototype.optimise = function(ast) {
    var rules;
    rules = this.rules;
    return walk(ast, function(inScope, ancestry) {
      var memo, rule, _i, _len, _ref3, _ref4;
      memo = this;
      _ref4 = (_ref3 = rules[this.className]) != null ? _ref3 : [];
      for (_i = 0, _len = _ref4.length; _i < _len; _i++) {
        rule = _ref4[_i];
        memo = rule.call(memo, inScope, ancestry);
      }
      return memo;
    });
  };

  return Optimiser;

})();
